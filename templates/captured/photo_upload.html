{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Photo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/main.css' %}" />
    <!-- JS -->
    <script src="{% static 'assets/js/main.js' %}" defer></script>
    <!-- heic2any for HEIC support -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
</head>

<body>

    <!-- Sticky Header -->
    <header style="position: sticky; top: 0; background: #111; padding: 1em 2em; z-index: 1000;">
        <nav style="display: flex; justify-content: space-between; align-items: center; color: white;">
            <h1 style="margin: 0;">
                <a href="{% url 'home' %}" style="color: white; text-decoration: none; border: none;">captured</a>
            </h1>
            <ul style="list-style: none; display: flex; gap: 1.5em; margin: 0;">
                <li><a href="{% url 'user_photos' %}" style="color: white; text-decoration: none;">{{ request.user.email }}</a></li>
                <li><a href="{% url 'home' %}" style="color: white; text-decoration: none;">Home</a></li>
                <li><a href="{% url 'signout' %}" style="color: white; text-decoration: none;">Logout</a></li>
            </ul>
        </nav>
    </header>

    {% if success %}
    <div style="background-color: #111; color: white; padding: 1em 2em; margin: 2em auto; max-width: 600px; text-align: center; border-radius: 4px; border: 1px solid #333;">
        {{ success }}
    </div>
    {% endif %}

    <!-- Upload Form -->
    <main style="padding: 3em 2em; max-width: 600px; margin: auto;">
        <h2 style="text-align: center;">Upload Your Photo</h2>
        <form method="POST" enctype="multipart/form-data" style="margin-top: 2em;">
            {% csrf_token %}

            <!-- Image Field -->
            <div style="margin-bottom: 1.5em;">
                <label for="image">Choose Image:</label><br>
                <input type="file" name="image" id="image" accept="image/*" required>
            </div>

            <!-- Image Preview -->
            <div id="preview-container" style="margin-top: 1.5em; display: none;">
                <p>Preview:</p>
                <img id="preview-image" src="" alt="Image preview" style="max-width: 100%; max-height: 300px; border: 1px solid #ccc; border-radius: 4px;" />
            </div>

            <!-- Title Field -->
            <div style="margin-bottom: 1.5em;">
                <label for="title">Title:</label><br>
                <input type="text" name="title" id="title" style="width: 100%;" required>
            </div>

            <!-- Description Field -->
            <div style="margin-bottom: 1.5em;">
                <label for="description">Description (optional):</label><br>
                <textarea name="description" id="description" rows="4" style="width: 100%;"></textarea>
            </div>

            <!-- Submit -->
            <button type="submit" style="padding: 0.5em 1.5em; background-color: #007bff; color: white; border: none; border-radius: 4px;">Upload</button>
        </form>
    </main>

    <!-- Image Preview Script -->
    <script>
        document.getElementById('image').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('preview-container');
            const previewImage = document.getElementById('preview-image');

            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };

                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
                previewImage.src = '';
            }
        });
    </script>

     <!-- for hiec image support -->
    <script>
        document.getElementById('image').addEventListener('change', function (event) {
          const file = event.target.files[0];
          const previewImage = document.getElementById('preview-image');
          const previewWarning = document.getElementById('preview-warning');
          const previewContainer = document.getElementById('preview-container');
    
          if (!file) return;
    
          const extension = file.name.split('.').pop().toLowerCase();
    
          if (extension === 'heic' || extension === 'heif') {
            // Convert HEIC to JPEG
            heic2any({ blob: file, toType: "image/jpeg" })
              .then(function (convertedBlob) {
                const url = URL.createObjectURL(convertedBlob);
                previewImage.src = url;
                previewContainer.style.display = 'block';
                previewWarning.style.display = 'none';
              })
              .catch(function () {
                previewWarning.textContent = '⚠️ Failed to preview HEIC image.';
                previewWarning.style.display = 'block';
                previewContainer.style.display = 'none';
              });
          } else {
            const reader = new FileReader();
            reader.onload = function (e) {
              previewImage.src = e.target.result;
              previewContainer.style.display = 'block';
              previewWarning.style.display = 'none';
            };
            reader.readAsDataURL(file);
          }
        });
    </script>

    <!-- restricts video upload -->
    <script>
        document.getElementById('image').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // Block videos based on MIME type
            if (file.type.startsWith('video/')) {
                alert('Videos are not allowed. Please upload an image.');
                event.target.value = ''; // Clear the file input
                return;
            }
        
            const previewContainer = document.getElementById('preview-container');
            const previewImage = document.getElementById('preview-image');
        
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });
    </script>

</body>
</html>
